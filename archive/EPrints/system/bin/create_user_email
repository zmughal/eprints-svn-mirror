#!/usr/bin/perl

######################################################################
#
# Create a new EPrints user from a subscription e-mail.
#
# The e-mail should be passed into STDIN.
#
######################################################################

use EPrints::Database;
use EPrintSite::User;
use EPrints::Log;
use EPrintSite::Session;

use strict;

my $session = EPrintSite::Session->new();

my $email = "";
my $access_level = $EPrintSite::User::access_levels[0];


# Extract info from the E-mail
while( <STDIN> )
{
	chop();
	
	$access_level = $EPrintSite::User::access_levels[1]
		if( /^Subject:.*newauthor/i );
	
	# Reply-To overrides From
	if( /^From:/ && $email eq "" )
	{
		s/^From:\s*//i;
		$email = $_;
	}

	if( /^Reply-To:/i )
	{
		s/^Reply-To:\s*//i;
		$email = $_;
	}

	# Security check
	if( /^Resent.*/ )
	{
		# Reject, it's been bounced
		EPrints::Log->log_entry(
			"create_user_email",
			"Mail from $email rejected due to resend header" );
		exit( 0 );
	}
}

if( $email eq "" || $email !~ /.+~.+\..+/ )
{
	EPrints::Log->log_entry(
		"create_user_email",
		"Garbled mail address: $email" );
	exit( 0 );
}	

EPrints::Database->connect();

my $new_user = EPrintSite::User->create_user_email( $session,
                                                    $email,
                                                    $access_level );

if( defined $new_user )
{
	EPrints::Log->log_entry(
		"create_user_email",
		"Successfully created new user $new_user->{username} for $email" );
	$new_user->send_introduction();
}
else
{
	my $db_error = $session->{database}->error();
	EPrints::Log->log_entry(
		"create_user_email",
		"Error creating user for $email: $db_error" );
}

$session->terminate();
