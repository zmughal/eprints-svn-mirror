######################################################################
#
# EPrints User Registration Page
#
# Creates a new user account, and e-mails the user.
#
######################################################################
#
# 27/10/99 - Created by Robert Tansley
#
######################################################################

use EPrints::User;
use EPrints::HTMLRender;
use EPrints::Database;
use EPrints::Log;
use EPrints::Session;

use strict;


my $session = EPrints::Session->new();

print $session->{render}->start_html( "User Registration" );

if( $session->{render}->seen_form() == 0 )
{
	EPrints::Log->debug( "register", "Not seen before, rendering form" );
	# First entry, render the form

	print "<P>To register as a <em>reader</em>, enter your e-mail address in the area below, ";
	print "and click on the \"Join as a reader\" button. ";
	print "Becoming a reader allows you to subscribe to the e-mail service. This service allows ";
	print "you to receive daily, weekly or monthly summaries of papers submitted to subject areas ";
	print "of your choice, and to receive general announcements about the $EPrintSite::SiteInfo::sitename service. ";
	print "You'll be sent an E-mail with a username and password, ";
	print "and instructions on how to complete the registration process.</P>\n";
	
	my $field = EPrints::MetaField->new( "reader-email:email::E-Mail address:0:1:1" );

	my %values = {};

	$session->{render}->render_form( [ $field ],
	                                 \%values,
	                                 0,
	                                 0,
	                                 [ "Join as a reader" ] );


	print "<P>To register to become an <em>author</em>, please enter your e-mail address below and click on the button. ";
	print "Again, you'll be sent an e-mail describing how to complete the registration ";
	print "process and how to submit papers. Your author account will also allow you to use ";
	print "all of the E-mail subscription services available to readers.</p>\n";

	$field = EPrints::MetaField->new( "author-email:email::E-Mail address:0:1:1" );

	%values = {};

	$session->{render}->render_form( [ $field ],
	                                 \%values,
	                                 0,
	                                 0,
	                                 [ "Join as an author" ] );
}
else
{
	# Process what's returned

	my $email;
	my $access_level;

	# Which button?	
	if( $session->{render}->param( "submit" ) eq "Join as a reader" ||
	    $session->{render}->param( "reader-email" ) ne "" )
	{
		EPrints::Log->debug( "register", "Joined as reader" );
		$email = $session->{render}->param( "reader-email" );
		$access_level = $EPrints::User::access_levels[0];
	}
	elsif( $session->{render}->param( "submit" ) eq "Join as an author" ||
	       $session->{render}->param( "author-email" ) ne "" )
	{
		EPrints::Log->debug( "register", "Joined as author" );
		$email = $session->{render}->param( "author-email" );
		$access_level = $EPrints::User::access_levels[1];
	}

	# If they entered an OK email address (i.e. it contains an @ and there's
	# something either side of it)...
	if( defined $email && $email =~ /.+\@.+\..+/ )
	{
		# Find user by email
		my $user = EPrints::User->user_with_email( $session, $email );

		if( defined $user )
		{
			# They've already got an account! Remind them....
			$user->send_reminder( "You already have a user account!" );
		}
		else
		{
			# Not one already, create one
			$user = EPrints::User->create_user_email( $session,
		                                             $email,
		                                             $access_level );
			# If successful, send the introductory mail.
			$user->send_introduction() if( defined $user );
		}

		if( defined $user )
		{
			# All created OK
			print "<CENTER><P>Thank-you for joining $EPrintSite::SiteInfo::sitename. You now have ";
			print ( $access_level eq $EPrints::User::access_levels[0] ?
			        "a reader" : "an author" );
			print " user account. An e-mail will be sent to you shortly describing the next step ";
			print "in the registration and/or subscription process.</P></CENTER>\n";
		}
		else
		{
			# Wasn't successful!
			EPrints::Log->log_entry( "register", "Error creating author: Possible DB error: ".$session->{database}->error() );

			print "<P>Unfortunately we were unable to create you a user account. ";
			print "Please e-mail <A HREF=\"mailto:$EPrintSite::SiteInfo::admin\">$EPrintSite::SiteInfo::sitename administration</A> ";
			print "explaining when this occurred and what you entered. We'll try and sort out ";
			print "the problem as soon as possible.</P>\n";
		}
		
		print "<CENTER><A HREF=\"$EPrintSite::SiteInfo::frontpage\">Click here to return to the $EPrintSite::SiteInfo::sitename front page.</A></CENTER>\n";
	}
	else
	{
		print "<P>You haven't entered a valid e-mail address. You need to enter a ";
		print "full e-mail address, of the form <strong>username\@domain.name</strong>.</P>\n";
		print "<P>You entered <code>$email</code>.</P>\n";
		print "<P>If you think you have entered a correct e-mail address despite this message ";
		print "appearing, please e-mail <A HREF=\"mailto:$EPrintSite::SiteInfo::admin\">$EPrintSite::SiteInfo::sitename administration</A>.</P>\n";

		print "<CENTER><A HREF=\"register\">Click here to try again</A></CENTER>\n";
	}
}

print $session->{render}->end_html();
$session->terminate();
