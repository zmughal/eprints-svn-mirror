<?xml version="1.0" encoding="utf-8"?>
<workflow xmlns="http://eprints.org/ep2/workflow" xmlns:ep="http://eprints.org/ep2/">
  <flow>
    <stage ref="type"/>
    <stage ref="files"/>
    <stage ref="core"/>
    <stage ref="subjects"/>
  </flow>


  <stage name="type">
    <component><field ref="type"><required/></field></component>
  </stage>

  <stage name="files">
    <component type="Upload"></component>
  </stage>


  <stage name="core">

    <component><field ref="title"><required/></field></component>
    <component><field ref="abstract"/></component>

    <ep:ifmatch name="type" merge="ANY" value="monograph">
      <component><field ref="monograph_type"><required/></field></component>
    </ep:ifmatch>
    <ep:ifmatch name="type" merge="ANY" value="thesis">
      <component><field ref="thesis_type"><required/></field></component>
    </ep:ifmatch>
    <ep:ifmatch name="type" merge="ANY" value="conference_item">
      <component><field ref="pres_type"><required/></field></component>
    </ep:ifmatch>

    <ep:ifmatch name="type" merge="ANY" value="book book_section">
      <component><field ref="creators_list"/></component>
      <component><field ref="editors_list"/></component>
    </ep:ifmatch>
    <ep:ifnotmatch name="type" merge="ANY" value="book book_section">
      <component><field ref="creators_list"><required/></field></component>
    </ep:ifnotmatch>

    <ep:ifnotmatch name="type" merge="ANY" value="patent"> 
      <component type="Field::Multi">
        <ep:ifmatch name="type" merge="ANY" value="book_section book article conference_item">
          <field ref="refereed"><required/></field>
        </ep:ifmatch>
        <field ref="ispublished"><required/></field>
      </component>
    </ep:ifnotmatch>

    <component type="Field::Multi">
      <title><phrase>Publication Details</phrase></title>
      <ep:ifmatch name="type" merge="ANY" value="patent">
        <field ref="date_issue"><required/></field>
        <field ref="official_url"/>
        <field ref="patent_applicant"><required/></field>
        <field ref="id_number"><required/></field>
        <field ref="pages"/>
      </ep:ifmatch>
      <ep:ifmatch name="type" merge="ANY" value="monograph">
        <field ref="institution"/>
        <field ref="department"/>
        <field ref="place_of_pub"/>
        <field ref="publisher"><required/></field>
        <field ref="id_number"/>
        <field ref="pages"/>
        <field ref="date_issue"/>
        <field ref="date_sub"/>
        <field ref="official_url"/>
      </ep:ifmatch>
      <ep:ifmatch name="type" merge="ANY" value="book">
        <field ref="date_issue"/>
        <field ref="date_sub"/>
        <field ref="place_of_pub"/>
        <field ref="publisher"><required/></field>
        <field ref="pages"/>
        <field ref="series"/>
        <field ref="volume"/>
        <field ref="number"/>
        <field ref="isbn"/>
        <field ref="official_url"/>
      </ep:ifmatch>
      <ep:ifmatch name="type" merge="ANY" value="other">
        <field ref="date_issue"/>
        <field ref="date_sub"/>
        <field ref="official_url"/>
        <field ref="place_of_pub"/>
        <field ref="publisher"><required/></field>
        <field ref="id_number"/>
      </ep:ifmatch>
      <ep:ifmatch name="type" merge="ANY" value="book_section">
        <field ref="pagerange"/>
        <field ref="book_title"><required/></field>
        <field ref="volume"/>
        <field ref="place_of_pub"/>
        <field ref="publisher"><required/></field>
        <field ref="pages"/>
        <field ref="id_number"/>
        <field ref="series"/>
        <field ref="number"/>
        <field ref="isbn"/>
        <field ref="date_issue"/>
        <field ref="date_sub"/>
        <field ref="official_url"/>
      </ep:ifmatch>
      <ep:ifmatch name="type" merge="ANY" value="thesis">
        <field ref="date_issue"><required/></field>
        <field ref="official_url"/>
        <field ref="institution"><required/></field>
        <field ref="department"><required/></field>
        <field ref="pages"/>
      </ep:ifmatch>
      <ep:ifmatch name="type" merge="ANY" value="conference_item">
        <field ref="date_issue"/>
        <field ref="date_sub"/>
        <field ref="pages"/>
        <field ref="official_url"/>
      </ep:ifmatch>
      <ep:ifmatch name="type" merge="ANY" value="article">
        <field ref="publication"><required/></field>
        <field ref="volume"/>
        <field ref="number"/>
        <field ref="pagerange"/>
        <field ref="date_issue"/>
        <field ref="date_sub"/>
        <field ref="id_number"/>
        <field ref="official_url"/>
        <field ref="issn"/>
      </ep:ifmatch>
    </component>
    <ep:ifmatch name="type" merge="ANY" value="conference_item">
      <component type="Field::Multi">
        <title><phrase>Event Details</phrase></title>
        <field ref="event_title"><required/></field>
        <field ref="event_type"><required/></field>
        <field ref="event_location"/>
        <field ref="event_dates"/>
      </component>
    </ep:ifmatch>

    <component><field ref="referencetext"/></component>
    <component><field ref="keywords"/></component>
    <component><field ref="note"/></component>
    <component><field ref="suggestions"/></component>

  </stage>

  <stage name="subjects">
    <component type="Field::Subject"><field ref="subjects"><required/></field></component>
  </stage>

</workflow>
