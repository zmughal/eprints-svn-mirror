# Makefile for eprints.org archive software
#
# __LICENSE
#

PREFIX=@prefix@
PERL=@PERL@
INSTALL=@INSTALL@
FULL_INSTALL=@FULL_INSTALL@

CONFIGURE_APACHE=@CONFIGURE_APACHE@
APACHE_CONFIG=@APACHE_CONFIG@
CREATE_DATABASE=@CREATE_DATABASE@
INSTALL_CRONTAB=@INSTALL_CRONTAB@

MYSQL=@MYSQL@
UNZIP=@UNZIP@
WGET=@WGET@
SENDMAIL=@SENDMAIL@

SITENAME=@SITE_NAME@
DESCRIPTION=@DESCRIPTION@
PORT=@PORT@
EPRINTS_HOSTNAME=@EPRINTS_HOSTNAME@
USERNAME=@USERNAME@
CREATE_USER=@CREATE_USER@
CREATE_USER_APP=@CREATE_USER_APP@
GROUP=@GROUP@
CREATE_GROUP=@CREATE_GROUP@
CREATE_GROUP_APP=@CREATE_GROUP_APP@
DATABASE=@DATABASE@
DB_HOST=@DB_HOST@
DB_PORT=@DB_PORT@
DB_SOCKET=@DB_SOCKET@
DB_USERNAME=@DB_USERNAME@
AUTOADMIN=@AUTOADMIN@
ADMIN=@ADMIN@
OAI_IDENTIFIER=@OAI_IDENTIFIER@
ID_STEM=@ID_STEM@
LIB_PREFIX=@LIB_PREFIX@
MOD_PREFIX=@MOD_PREFIX@

core_dirs_exe=bin cgi cgi/staff cgi/users openarchives openarchives/Common openarchives/Config openarchives/Main openarchives/Services openarchives/Services/Info openarchives/Services/Repository openarchives/Tests
core_dirs_plain=perl_lib/${LIB_PREFIX}EPrints
site_dirs_exe=
site_dirs_plain=cfg html html/documents perl_lib/${LIB_PREFIX}EPrintSite static static/help static/images static/staff
htaccess_files=cgi/staff/.htaccess cgi/users/.htaccess static/staff/.htaccess

all:
	rm -rf to-install
	mkdir to-install
	mkdir to-install/bin
	mkdir to-install/perl_lib
	tar cf - cgi openarchives perl_lib/EPrints | tar xf - -C to-install
ifneq ($(LIB_PREFIX),)
	mkdir to-install/perl_lib/${LIB_PREFIX}
	mv to-install/perl_lib/EPrints to-install/perl_lib/${LIB_PREFIX}
endif
	for i in bin/*; do \
		sed <$$i 's%^#!.*$$%#!${PERL} -I${PREFIX}/perl_lib%' >to-install/$$i ; \
	done
	files=`find to-install/cgi -type f | grep -v '.htaccess'` ; \
	for i in $$files ; do \
		echo "use lib '${PREFIX}/perl_lib';" >$$i.new ; \
		cat $$i >> $$i.new ; \
		mv -f $$i.new $$i ; \
	done
ifeq ($(FULL_INSTALL),1)
	@./readpw "Enter password to use for eprints database: " >_db_passwd ; \
	chmod 600 _db_passwd
	tar cf - perl_lib/EPrintSite html static cfg | tar xf - -C to-install
ifneq ($(LIB_PREFIX),)
	mv to-install/perl_lib/EPrintSite to-install/perl_lib/${LIB_PREFIX}
endif
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "sitename" "${SITENAME}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "description" "${DESCRIPTION}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "automail" "${AUTOADMIN}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "admin" "${ADMIN}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "host" "${EPRINTS_HOSTNAME}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "database" "${DATABASE}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "db_host" "${DB_HOST}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "db_port" "${DB_PORT}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "db_socket" "${DB_SOCKET}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "username" "${DB_USERNAME}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "archive_identifier" "${OAI_IDENTIFIER}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "eprint_id_stem" "${ID_STEM}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "local_root" "${PREFIX}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "server_perl_port" "${PORT}"
	if [ ${PORT} != 80 ] ; then \
		${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "server_static" "http://\$$${MOD_PREFIX}EPrintSite::SiteInfo::host:${PORT}" ; \
		${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "server_perl" "http://\$$${MOD_PREFIX}EPrintSite::SiteInfo::host:${PORT}/perl" ; \
	fi
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "unzip_executable" "${UNZIP}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "wget_executable" "${WGET}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "sendmail_executable" "${SENDMAIL}"
	${PERL} setsitevar "to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm" "password" `cat _db_passwd`
	chmod 600 to-install/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm
endif
ifneq ($(LIB_PREFIX),)
	files=`find to-install/cgi -type f ; find to-install/openarchives -type f ; find to-install/perl_lib -type f ; find to-install/bin -type f` ; \
	for i in $$files ; do \
		sed <$$i 's%EPrints::%${MOD_PREFIX}EPrints::%g; s%EPrintSite::%${MOD_PREFIX}EPrintSite::%g;' >$$i.new ; \
		mv -f $$i.new $$i ; \
	done
endif


install:
ifeq ($(CREATE_GROUP),1)
	${CREATE_GROUP_APP} ${GROUP}
endif
ifeq ($(CREATE_USER),1)
	${CREATE_USER_APP} -s /bin/false -d ${PREFIX} -g ${GROUP} ${USERNAME}
endif
	for i in ${core_dirs_exe} ; do \
		${INSTALL} -d -m 755 -o ${USERNAME} -g ${GROUP} ${PREFIX}/$$i ; \
		files=`${PERL} findfiles to-install/$$i` ; \
		[ -n "$$files" ] && ${INSTALL} -m 755 -o ${USERNAME} -g ${GROUP} $$files ${PREFIX}/$$i ; \
	done
	for i in ${core_dirs_plain} ; do \
		${INSTALL} -d -m 755 -o ${USERNAME} -g ${GROUP} ${PREFIX}/$$i ; \
		files=`${PERL} findfiles to-install/$$i` ; \
		[ -n "$$files" ] && ${INSTALL} -m 644 -o ${USERNAME} -g ${GROUP} $$files ${PREFIX}/$$i ; \
	done
ifeq ($(FULL_INSTALL),1)
	#Commented oot because there are no site_dirs_exe
	#for i in ${site_dirs_exe} ; do \
	#	${INSTALL} -d -m 755 -o ${USERNAME} -g ${GROUP} ${PREFIX}/$$i ; \
	#	files=`${PERL} findfiles to-install/$$i` ; \
	#	[ -n "$$files" ] && ${INSTALL} -m 755 -o ${USERNAME} -g ${GROUP} $$files ${PREFIX}/$$i ; \
	#done
	for i in ${site_dirs_plain} ; do \
		${INSTALL} -d -m 755 -o ${USERNAME} -g ${GROUP} ${PREFIX}/$$i ; \
		files=`${PERL} findfiles to-install/$$i` ; \
		[ -n "$$files" ] && ${INSTALL} -m 644 -o ${USERNAME} -g ${GROUP} $$files ${PREFIX}/$$i ; \
	done
	chmod 600 ${PREFIX}/perl_lib/${LIB_PREFIX}EPrintSite/SiteInfo.pm
	${PREFIX}/bin/update_htaccess
endif
ifeq ($(CREATE_DATABASE),1)
	@echo "Enter MySQL database root password"
	${MYSQL} -u root -p -e 'create database ${DATABASE} ; GRANT SELECT, INSERT, UPDATE, DELETE, CREATE ON ${DATABASE}.* TO ${DB_USERNAME}@localhost IDENTIFIED BY "'`cat _db_passwd`'"'
	rm -f _db_passwd
else
	@echo "*** You need to create the ${DATABASE} database if it doesn't exist"
endif
ifeq ($(INSTALL_CRONTAB),1)
	echo "0 0  * * * ${PREFIX}/bin/subs_daily%15 0 * * 0 ${PREFIX}/bin/subs_weekly%30 0 1 * * ${PREFIX}/bin/subs_monthly%0 1  * * * ${PREFIX}/bin/generate_views" | tr '%' '\n' | crontab -u ${USERNAME} -
endif
ifeq ($(CONFIGURE_APACHE),1)
	${PERL} update_apache_conf ${APACHE_CONFIG} ${PREFIX} ${HOSTNAME} ${PORT} ${USERNAME} ${GROUP}
	@echo "*** EXPERIMENTAL configuration of Apache complete.  You will need"
	@echo "*** to restart the Apache server."
endif
ifeq ($(FULL_INSTALL),0)
	@echo "*** Upgrade complete.  You will need to restart your Web server"
	@echo "*** before the upgrade will take proper effect.  Be sure you have"
	@echo "*** read the documentation to make sure that there's nothing else"
	@echo "*** you need to do."
else
	@echo "*** Installation complete."
	@echo "***"
	@echo "*** You will need to set up your mail system so that mail arriving at"
	@echo "*** ${AUTOADMIN}"
	@echo "*** gets piped to the ${PREFIX}/bin/process_mail script."
	@echo "***"
	@echo "*** Edit the metadata configuration files in ${PREFIX}/cfg"
	@echo "*** if necessary.  Then run as root:"
	@echo "*** su -s /bin/sh -c ${PREFIX}/bin/create_databases ${USERNAME}"
	@echo "*** and"
	@echo "*** su -s /bin/sh -c ${PREFIX}/bin/update_laf ${USERNAME}"
	@echo "***"
	@echo "*** You will also need to set up an initial staff user, and an area"
	@echo "*** for storing eprint files in ${PREFIX}/html/documents, as described"
	@echo "*** in the installation document."
endif
ifeq ($(INSTALL_CRONTAB),0)
	@echo "***"
	@echo "*** You will also need to set up a crontab, as described in the installation"
	@echo "*** document."
endif
