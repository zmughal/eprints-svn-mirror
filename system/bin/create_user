#!/usr/bin/perl -w

######################################################################
#
#  Create a new EPrints user
#
#  Usage: create_user <username> <email> <access-level>
#
######################################################################
#
#  __COPYRIGHT__
#
# Copyright 2000-2008 University of Southampton. All Rights Reserved.
# 
# __LICENSE__
#
######################################################################

use EPrints::Database;
use EPrints::User;
use EPrints::Session;

use strict;


if( $#ARGV < 3 || $#ARGV > 4 )
{
	die "Usage: create_user <siteid> <username> <email> <access-level> [<password>]\n";
}

my $session = EPrints::Session->new( 1 , $ARGV[0] );

my $valid_access_level = 0;
foreach (@{$session->{metainfo}->get_types( "user" )})
{
	$valid_access_level = 1 if( $ARGV[3] eq $_ );
}

if( $valid_access_level )
{
	my $new_user = EPrints::User::create_user( $session,
	                                           $ARGV[1],
	                                           $ARGV[2],
	                                           $ARGV[3] );

	if( $#ARGV == 3 )
	{
		$new_user->{passwd} = $ARGV[4];
		$new_user->commit();
	}

	if( defined $new_user )
	{
		print STDERR "Successfully created new user:\n";
		print STDERR " User ID:  $new_user->{username}\n";
		print STDERR " Password: $new_user->{passwd}\n";
	}
	else
	{
		my $db_error = $session->{database}->error();
		print STDERR "Error creating user: $db_error\n";
	}
}
else
{
	print STDERR "Invalid access level. Valid access levels are:\n";
	foreach (@{$session->{metainfo}->get_types( "user" )})
	{
		print "  $_\n";
	}
}

$session->terminate();
