#!/usr/bin/perl -w

use FindBin;
use lib "$FindBin::Bin/../perl_lib";

use strict;

use EPrints;

if(!defined $ARGV[0] || !defined $ARGV[1])
{
       print "\nUsage is:";
       print "\n\tepm repository_id [install|remove] [app_name|app_path|app_url] [--force]\n\n";
       exit(1);
}

my $repository = new EPrints::Session( 1, $ARGV[0] ) or die("cant create Session object");

my $operation = $ARGV[1];

my $path_in = $ARGV[2];

my $force = 0;

if (defined $ARGV[3]) {
	if ( "$ARGV[3]" eq "--force" ) {

		$force = 1;

	}
}
my $rc = 0;
my $message = "";
my $package_name = "";
if ( $operation eq "install") {
	
	if ((substr $path_in, 0,7) eq "http://")  
	{
		my ($tmpdir,$epm_file) = EPrints::EPM::download_package($repository,$path_in);
		($rc, $message) = EPrints::EPM::install($repository,${$epm_file},$force);
	} else {
		($rc, $message) = EPrints::EPM::install($repository,$path_in,$force);
	}

} elsif ($operation eq "remove" ) {
	
	($rc, $message) = EPrints::EPM::remove($repository,$path_in,$force);

} elsif ($operation eq "backup" ) {
	
	$message = EPrints::EPM::make_backup($repository, $path_in);

} elsif ($operation eq "check_install") {
	
	$message = EPrints::EPM::check_install($repository);

} elsif ($operation eq "list") {

	my $installed_epms = EPrints::EPM::get_installed_epms($repository);
	$message = "Listing Installed EPMs:\n";
	foreach my $installed_app (@$installed_epms) {
		$message .= $installed_app->{package} . "\n";
	}

} elsif ($operation eq "upgrade") {
	
	my $installed_epms = EPrints::EPM::get_installed_epms($repository);

	my $store_epms = EPrints::EPM::retrieve_available_epms($repository);

	my $update_epms = EPrints::EPM::get_epm_updates($installed_epms, $store_epms);

	$message = "Listing Avaialble Updates, use install command on each one individually to install:\n";
	foreach my $update_app (@$update_epms) {
		$message .= $update_app->{package} . "\n";
	}

}

print $message . "\n";

1;
