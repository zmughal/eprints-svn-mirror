#!/usr/bin/perl -w 

######################################################################
#
#  Subject View Generator
#
#   This script generates the per-subject views of documents, and
#   regenerates the front page accordingly.
#
#   This script should be run periodically, AT LEAST every day but
#   preferably every hour.  If the archive on a busy or large site,
#   it might be an idea to nice this.
#
######################################################################
#
#  __COPYRIGHT__
#
# Copyright 2000-2008 University of Southampton. All Rights Reserved.
# 
#  __LICENSE__
#
######################################################################

use EPrints::EPrint;
use EPrints::Session;
use EPrints::HTMLRender;
use EPrints::Subject;
use EPrints::Log;

my $session = new EPrints::Session( 1 , $ARGV[0] );


# Get all of the available subjects
my( $subjects, $subjectmap ) = EPrints::Subject::get_all( $session );

my $langid;
foreach $langid ( keys %EPrints::Site::General::languages )
{
	my $dir =  $session->getSite->getConf( "local_html_root" ).
		"/".$langid."/view";
	unless( -d $dir )
	{
		print "mkdir $dir\n";
		mkdir( $dir, 0775 ) or die "Can't make directory $dir: $!\n";
	}
	# Start with the root
	&write_subject_view( 
		$session, 
		$langid, 
		$dir."/index.html",
		new EPrints::Subject( $session ) );


	# Now do each of the subjects

	foreach (@$subjects)
	{
		&write_subject_view( 
			$session, 
			$langid, 
			$dir."/".$_->{subjectid}.".html",
			$_ );
	}
}

$session->terminate();



sub write_subject_view
{
	my( $session, $langid, $file, $subject ) = @_;
	
	$session->newPage( $langid );
	my $page = $session->makeDocFragment;
	
	# Title (cjg NOT INTL)
	my $title = "Browse by Subject: ".$subject->{name};
	
	# Tree at the top
	$page->appendChild( $session->subjectTree( $subject ) );
	my $hr = $session->make_element( "hr",
			size => 2,
			noshade => "noshade" );
	$page->appendChild( $hr );
	# The entries themselves
	my @eprints = $subject->posted_eprints( 
		$session->getSite->getDataSet( "archive" ) );

	# not INTL!cjg
	my $p = $session->make_element( "p" );
	my $n = $session->make_element( "span", class=>"number" );
	$p->appendChild( $session->makeText("This subject category contains "));
	$n->appendChild( $session->makeText(scalar @eprints) );
	$p->appendChild( $n );
	$p->appendChild( $session->makeText(" entries"));
	$page->appendChild( $p );		
	
	my $eprint;
	foreach $eprint (@eprints)
	{
		$p = $session->make_element( "p" );
		$p->appendChild( $eprint->toHTMLLink );
		$page->appendChild( $p );
	}
	$session->buildPage( $title, $page );
	$session->pageToFile( $file );
}
