#!/usr/bin/perl -w -I/opt/eprints/perl_lib

######################################################################
#
#  Subject View Generator
#
#   This script generates the per-subject views of documents, and
#   regenerates the front page accordingly.
#
#   This script should be run periodically, AT LEAST every day but
#   preferably every hour.  If the archive on a busy or large site,
#   it might be an idea to nice this.
#
######################################################################
#
#  __COPYRIGHT__
#
# Copyright 2000-2008 University of Southampton. All Rights Reserved.
# 
#  __LICENSE__
#
######################################################################

use EPrints::EPrint;
use EPrints::Session;
use EPrints::HTMLRender;
use EPrints::Subject;

use strict;

my $session = new EPrints::Session( 1 , $ARGV[0] );
exit( 1 ) unless( defined $session );

my $fieldids = [ "year","subjects","groups","title","ispublished","type" ,"datestamp"];

my $ds = $session->get_archive()->get_dataset( "archive" );
foreach( @{$fieldids} )
{
	my $field = $ds->get_field( $_ );
	print "\n-----------------------------------------\n\n";
	print ": $_ ".($field->is_browsable())."\n";
	unless( $field->is_browsable() )
	{
		print STDERR "Cannot generate browse pages for field \"".$_."\"\nType \"".$field->get_type()."\" cannot be browsed.\n";
		next;
	}
	make_field_browse_pages( $field );
}
exit;

sub make_field_browse_pages
{
	my( $field ) = @_;

	my( @values ) = $field->get_values( $session );
	my $value;
	foreach $value ( @values )
	{
		print "$value: ".$field->get_value_label( $session, $value )."\n";
	}
}




# cjg redo with new subject system!

# Get all of the available subjects
my( $map, $rmap ) = EPrints::Subject::get_all( $session );#cjg change

my $langid;
foreach $langid ( @{$session->get_archive()->get_conf( "languages" )} )
{
	my $dir =  $session->get_archive()->get_conf( "local_html_root" ).
		"/".$langid."/view";
	unless( -d $dir )
	{
		print "mkdir $dir\n";
		mkdir( $dir, 0775 ) or die "Can't make directory $dir: $!\n";
	}
	# Start with the root
	&write_subject_view( 
		$session, 
		$langid, 
		$dir."/index.html",
		new EPrints::Subject( $session ) );


	# Now do each of the subjects

	foreach( keys %{$map} )
	{
		&write_subject_view( 
			$session, 
			$langid, 
			$dir."/$_.html",
			$map->{$_} );
	}
}

$session->terminate();



sub write_subject_view
{
	my( $session, $langid, $file, $subject ) = @_;
	
	$session->new_page( $langid );
	my $page = $session->make_doc_fragment();
	
	# Title (cjg NOT INTL)
	my $title = "Browse by Subject: ".$subject->{name};
	
	# Tree at the top
	$page->appendChild( $session->render_subjects( undef, $subject->get_value( "subjectid" ) ) );
	$page->appendChild( $session->render_ruler() );
	# The entries themselves
	my @eprints = $subject->posted_eprints( 
		$session->get_archive()->get_dataset( "archive" ) );

	# not INTL!cjg
	my $p = $session->make_element( "p" );
	my $n = $session->make_element( "span", class=>"number" );
	$p->appendChild( $session->make_text("This subject category contains "));
	$n->appendChild( $session->make_text(scalar @eprints) );
	$p->appendChild( $n );
	$p->appendChild( $session->make_text(" entries"));
	$page->appendChild( $p );		
	
	my $eprint;
	foreach $eprint (@eprints)
	{
		$p = $session->make_element( "p" );
		$p->appendChild( $eprint->render_citation_link() );
		$page->appendChild( $p );
	}
	$session->build_page( $title, $page );
print STDERR "Writing: $file\n";
	$session->page_to_file( $file );
}
