#!/usr/bin/perl -w

######################################################################
#
#  Subject View Generator
#
#   This script generates the per-subject views of documents, and
#   regenerates the front page accordingly.
#
#   This script should be run periodically, AT LEAST every day but
#   preferably every hour.  If the archive on a busy or large site,
#   it might be an idea to nice this.
#
######################################################################
#
#  __COPYRIGHT__
#
# Copyright 2000-2008 University of Southampton. All Rights Reserved.
# 
#  __LICENSE__
#
######################################################################

use EPrints::EPrint;
use EPrints::Session;
use EPrints::HTMLRender;
use EPrints::Subject;
use EPrints::Log;

my $session = new EPrints::Session( 1 , $ARGV[0] );


# Get all of the available subjects
my( $subjects, $subjectmap ) = EPrints::Subject::get_all( $session );

my $langid;
foreach $langid ( keys %EPrints::Site::General::languages )
{
	my $dir =  $session->getSite->getConf( "local_html_root" ).
		"/".$langid."/view";
	unless( -d $dir )
	{
		print "mkdir $dir\n";
		mkdir( $dir, 0775 ) or die "Can't make directory $dir: $!\n";
	}
	# Start with the root
	&write_subject_view( 
		$session, 
		$langid, 
		$dir."/index.html",
		new EPrints::Subject( $session ) );

	# Now do each of the subjects

	foreach (@$subjects)
	{
		&write_subject_view( 
			$session, 
			$langid, 
			$dir."/".$_->{subjectid}.".html",
			$_ );
	}
}

$session->terminate();



sub write_subject_view
{
	my( $session, $langid, $file, $subject ) = @_;
	
	# Open the subject view file
	my $ok = open( OUT, ">$file" );
	
	unless( $ok )
	{
		EPrints::Log::log_entry(
			"generate_views",
			"Error writing subject view for $subject->{subjectid} to $file:".
				" $!" );
		return;
	}
	
	# Title
	print OUT "Browse by Subject: $subject->{name}" ;
	
	# Tree at the top
	print OUT $session->subjectTree( $subject );
	print OUT "<HR noshade size=\"2\">\n";	

	# The entries themselves
	my @eprints = $subject->posted_eprints( EPrints::Database::table_name( "archive" ) );

	print OUT "<P>This subject category contains <STRONG>".($#eprints+1).
		"</STRONG> entries</P>\n";
	
	foreach (@eprints)
	{
		print OUT "<P>";
		print OUT $session->{render}->render_eprint_citation( $_, 1, 1 );
		print OUT "</P>\n";
	}
	
}
