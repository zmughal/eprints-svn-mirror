#!/usr/bin/perl

use strict;
use warnings;

use EPrints;

my( $repoid ) = @ARGV;

my $droid_path = "/home/dct05r/temp/DROID_v3.0";
my $java_path = "/home/dct05r/java/jdk1.6.0_06/bin";

my $session = EPrints::Session->new( 1, $repoid );

my $dataset = $session->get_repository->get_dataset( "file" );

unless( $session->get_repository->get_conf( "invocation", "droid" ) )
{
	die <<EOH;
You do not have droid configured in your SystemSettings ...
EOH
}

while(1)
{
	my $check = 10;
	my $searchexp = EPrints::Search->new(
		session => $session,
		dataset => $dataset,
	);
	$searchexp->add_field( $dataset->get_field( "datasetid" ), "document" );
	$searchexp->add_field( $dataset->get_field( "bucket" ), "data" );
	my $list = $searchexp->perform_search;
	$list->map(sub {
		my( $session, $dataset, $file ) = @_;
		if( 1 || $check-- == 0 )
		{
			$check = 10;
			my $list = &fetch_unset();
			if( $list->count > 0 )
			{
				#print "Found ".$list->count." unset files!\n";
				#print "Found file: ".$file->get_value( "filename" )."/".($file->get_value("pronom_uid")||"(null)")."\n";
				my $fh = $file->get_local_copy();
				my $droid_xml = File::Temp->new;
				my $droid_cmd = "$java_path/java -jar $droid_path/droid.jar -S$droid_path/DROID_SignatureFile_V13.xml -Odroid -FXML -L$fh";
				print "$droid_cmd\n";
				$session->get_repository->exec( "droid",
					SOURCE => $fh,
					TARGET => "$droid_xml",
				);
				# $list->map(sub { ... });
			}
		}
	});
	last;
}

sub fetch_unset
{
	my $searchexp = EPrints::Search->new(
		session => $session,
		dataset => $dataset,
		custom_order => "-mtime",
	);

	$searchexp->add_field( $dataset->get_field( "datasetid" ), "document" );
	$searchexp->add_field( $dataset->get_field( "bucket" ), "data" );
	$searchexp->add_field( $dataset->get_field( "pronom_uid" ), "", "EX" );

	my $list = $searchexp->perform_search;

	return $list;
}

END
{
	$session->terminate;
}
